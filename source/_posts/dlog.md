---
title: 现代工业|开发日志
date: 2020-08-15 20:31:38
toc_number: false
categories:
	- Java
	- 现代工业
tags: 
	- 现代工业
cover: https://cdn.jsdelivr.net/gh/EmptyDreams/resources/b1.png
description: 有关“现代工业”的所有代码更新记录以及简单介绍
---

# 简介

&emsp;&emsp;这里讲罗列出“现代工业”所有的更新记录以及更新内容的介绍。

&emsp;&emsp;目前所有更新日志代号均以“#”开头，以后可能会有变更。

&emsp;&emsp;关于项目的有关内容，可以查看“[爱发电](https://afdian.net/@emptydreams)”中的介绍。

------

# 功能开发顺序

<div class="text" style=" text-align:center;"><font size="2px" font color="#66ccff">（顺序由内测组投票决定）</font></div>

| 序号  |        功能        | 难度 |  进度  |
| :---: | :----------------: | :--: | :----: |
| **1** | 更舒适的合成表查看 |  3   |  完成  |
| **2** |      管道系统      |  5   | 编写中 |
| **3** |    高级配置系统    |  2   |  待机  |
| **4** |     红石能衰退     |  ?   |  待机  |
| **5** |       储能器       |  3   |  待机  |
| **6** |   完整的金属冶炼   |  4   |  待机  |
| **7** |      精制工具      |  4   |  待机  |
| **8** |     更多的电器     |  3   |  待机  |



---

# 新的更新

## #70.移除“属性”功能

&emsp;&emsp;由于`属性`功能与附魔玩法重复并且存在漏洞，所以决定将该功能删除。

## #71.添加虚拟dor

&emsp;&emsp;添加了`VarDataReader`类，用于在不复制任何数据的情况下进行`data`读取，优化了`IDataReader#readData()`的时间成本及空间成本。

## #72.修复自动化网络通信的BUG

&emsp;&emsp;修复基于方块的网络通信中可能存在的进行网络通信时客户端世界未构造完毕的BUG。

## #73.修复合成表填充显示异常

&emsp;&emsp;修复合成表填充后GUI显示异常，通过在填充合成表后代码触发数据同步来更新GUI显示。

## #74.支持自动注册流体

&emsp;&emsp;支持自动注册流体、流体物品、流体方块及流体桶。

------

# 历史记录：

## #1 项目的起点

&emsp;&emsp;建立现代工业（ModernIndustry）项目，并建立主类以及完成最为基础的架设，此时MI没有任何代码层面及用户层面的功能。

## #2 建立电力体系

&emsp;&emsp;简单建立电力系统中的基础概念：发电机、用电器、导线。

|    分类    |                                                         介绍 |
| :--------: | -----------------------------------------------------------: |
| **发电机** |                               制造能量的机器全部归类于发电机 |
| **用电器** |                               消耗能量的机器全部归类与用电器 |
|  **导线**  | 因为导线采用了和机器不同的算法，所以导线单独分类，用于传输能量 |
|    补充    |                 储电器同时属于发电机与用电器分类，不属于导线 |

## #3 一切的开端---第一个电器

&emsp;&emsp;创建了MI中的第一个机器——压缩机，不过其在电力系统完工之前不需要电能就可以运行，前期主要用于测试代码功能，在电力系统制作时为其添加了消耗电能的功能。

## #4 构建电力系统的基本框架

&emsp;&emsp;构建了电力系统的基本内容与规范，包括：电能概念、电压概念、EleWorker……

|   分类    |                                                         介绍 |
| :-------: | -----------------------------------------------------------: |
|   电能    |                               用于表示能量数量的一个指示数字 |
|   电压    | 用于表示电压等级的一个指示数字，理论上支持所有非负整数，电压与电能无直接联系 |
| EleWorker |           电力系统的“工作核心”，系统的所有操作都封装在该类中 |
|  计数器   | 用于在用电器输入电压不符合需求电压时计数并在计数器达到阈值时执行指令的工具 |
| 线路缓存  | 用于存储线路计算的缓存信息，以此减少线路计算的时间和成本（可以选择不实现缓存功能） |

## #5 第一个导线

&emsp;&emsp;创建了MI中的第一种导线——粗制导线，也是开发前期阶段唯一可用的导线。导线中实现了信息存储、渲染、缓存三大功能，而线路计算则写入了缓存中。

### 线路计算原理：

&emsp;&emsp;在线路计算中，包含三大流程：寻找线路、计算线路、反馈信息。

&emsp;&emsp;其中前两个流程可以用等价的方法替换，顺序也可以调整，但反馈信息必须在最后进行。

|      分类      |                                                         介绍 |
| :------------: | -----------------------------------------------------------: |
|  **寻找线路**  |                           寻找指定用电器到非指定发电机的路径 |
|  **计算线路**  |             计算线路上损耗的电能及发电机最终输出的电能和电压 |
|  **反馈信息**  |           向电力系统反馈计算结果，系统将根据结果进行数据更新 |
|      路径      | 表示线路中指定起点到指定终点经过的所有导线方块，包含起点与终点，不包含机器方块 |
|  非指定发电机  | MI采用被动式电能运输，所以寻找线路时一般并不知道目标发电机的位置 |
| 被动式电能运输 | 用电器主动向电力系统发起传输电能的请求，然后由电力系统负责完成其余工作 |

&emsp;&emsp;不过MI中的粗制导线没有完全按照上述方法进行，而是按照：`读取缓存 -> 计算线路 -> 反馈信息`的流程工作。

|     分类     |                                                         介绍 |
| :----------: | -----------------------------------------------------------: |
| **读取缓存** |               从发电机列表中直接寻找目标发电机，然后读取缓存 |
| **计算线路** |             若缓存不存在则计算起点到终点的最短路径并写入缓存 |
|  发电机列表  | 一条线路中所有导线共享同一个缓存，每一根导线都负责维护缓存中的发电机列表 |

&emsp;&emsp;上述列出的第一种方式为粗制导线最初使用的工作流程，后因为技术原因替换为第二种。

## #6 发电机的出现

&emsp;&emsp;添加了第一个发电机方块——无线电能方块，用于测试电力系统是否可以正常工作，也用于给玩家提供一个万能的创造模式用发电机。

## #7 完善电力系统框架

&emsp;&emsp;这是对电力系统第N次重构，完善了电力系统的功能，删除了不需要的部分。从该版本起，缓存彻底被排除在电力系统规范外，是否实现缓存与电力系统工作没有任何关系。

## #8 合成表模块的第一次开发

&emsp;&emsp;原版的合成表本人并不会使用，所以干脆写了一个独立的合成表模块，其中所有内容都是可变的，拓展性较强，但存在结构混乱的缺陷。

## #9 加入自动化概念

&emsp;&emsp;建立了`registry`包，用于自动化注册方块、物品等内容，摆脱手动编码的烦恼。

## #10 自动化的推进

&emsp;&emsp;除方块、物品的自动化注册外，又新提供了部分内容，此时自动化系统变得较为完善，包括以下内容：

|               分类               |                                                         介绍 |
| :------------------------------: | -----------------------------------------------------------: |
| **方块、物品、TileEntity的注册** |                                                 基本游戏内容 |
|           **网络通讯**           |     封装了网络通讯相关的代码，使服务端与客户端的沟通更加简便 |
|           **数据存储**           | 支持部分数据类型的自动存储，拜托手动编码的烦恼，不过目前仍存在一些限制 |
|           **GUI绘制**            |  支持运行时绘制GUI材质，拜托手动绘制材质及寻找组件坐标的烦恼 |
|           **JSON生成**           |                                 自动生成方块、物品的JSON文件 |

## #11 BUG修复

&emsp;&emsp;修复部分BUG。

## #12 GUI绘制

&emsp;&emsp;完善GUI绘制的功能。

## #13 新的功能——属性

&emsp;&emsp;在工具使用时提供额外效果的玩意，有点类似于附魔。

## #14 工具类

&emsp;&emsp;提供了一系列`Util`类，封装了一些常用操作，缩减了代码量。

## #15 时刻表

&emsp;&emsp;用于在指定时间后执行指定操作，因为某些功能限制，在`#38`时被移除。

## #16 添加一系列物品及机器

## #17 GUI绘制的完善

&emsp;&emsp;解决了GUI绘制坐标点寻找烧脑的问题，彻底摆脱思考，同时优化了性能。

## #18 重写合成表模块

&emsp;&emsp;因为合成表模块结构过于混乱，没有任何易用性及美观性，所以重新设计、编写了合成表模块：

|        分类        |                                                         介绍 |
| :----------------: | -----------------------------------------------------------: |
| `CraftGuide<T, R>` |                                   创建、管理合成表，数据可变 |
|     `ItemSol`      |                       存储物品列表，可有序可无序，数据不可变 |
|   `ItemElement`    |                                     存储单个物品，数据不可变 |
|      `IShape`      | 合成表，内部存储原料列表和产物列表，可有序可无序，数据不可变 |

## #19 修复线路计算中的问题

&emsp;&emsp;将线路计算方式换为`#5`中的第二种方式。

## #24 优化自动数据存储

&emsp;&emsp;减少了存储类名需要的成本

## #34 优化扳手的玩法

&emsp;&emsp;扳手玩法改为右键不同区域转向不同的方向，`shift + 右键`拆除方块，暂时没有耐久。

## #35 完善自动注册的功能

&emsp;&emsp;使自动注册支持对物品、方块列表进行排序，保证在每次创建存档时创造模式物品栏中的排列顺序不变化。

## #36 第一次材质扩充

## #37 增强合成表模块

&emsp;&emsp;修改了MC原版注册JSON合成表的方法，在其中加入了注册MI的JSON合成表的代码，自此注册合成表可以不再面对繁杂的代码编写。

## #38 修复服务端支持

&emsp;&emsp;修复因代码问题导致的服务端启动崩溃。

## #39 GUI添加鼠标事件

&emsp;&emsp;GUI支持鼠标事件，在鼠标移出、移入、按下、松开或点击控件时会自动调用控件的方法（前提是控件注册了相关事件）。一个控件可以重复注册同一种事件，在事件被触发时所有相同事件都会被触发，不会被遗漏。

## #40 优化自动化网络传输结构

&emsp;&emsp;自动化网络传输采用“注册”结构，添加新的网络传输方式变得更加方便。同时网络传输不再主动询问用户是否需要发送信息，更加偏向半自动化，采用用户主动向网络传输系统发送请求的方式，减少了运行开支。

## #41.添加合成表显示

&emsp;&emsp;预期设计是点击机器的进度条可以查看该机器所有的合成表，不过目前由于网络通信的原因还未添加触发合成表显示的机制。以后还会为合成表添加更多的功能，例如：自动装填。

## #42.修复导线网络通信漏洞

&emsp;&emsp;修复导线的网络通信中由于IDEA“重命名”功能的BUG出现的一些神奇的代码。

## #43.网络通信新功能——GUI通信

&emsp;&emsp;网络通信支持客户端与服务端GUI之间的互相通信。

## #44.GUI支持事件进行网络通信

&emsp;&emsp;MIFrame添加了用于支持注册的事件进行网路单向通信的接口，由于一些设计缺陷以及考虑到代码简洁性的原因，事件的网络通信暂时只支持客户端到服务端的通信（即只能由客户端发送信息到服务端）。

## #45-修复GUI根据鼠标坐标获取组件错误的问题

&emsp;&emsp;原本获取组件的算法有问题，这次修改了算法。

## #46-修复Group内添加的组件鼠标事件错误的问题

&emsp;&emsp;原本的事件触发方式导致`Group`内的鼠标事件无法触发，这次修改了触发方式，使`Group`内组件的鼠标事件也可以正确触发。

## #47-修复GUI按钮响应错误的问题

&emsp;&emsp;修复GUI按钮鼠标事件的错误响应，以及为鼠标点击添加了音效。

## #48-修复GUI组件onAddToGUI方法运行两次

&emsp;&emsp;`StaticFrameClient`构造函数中的错误用法导致客户端`onAddToGUI`运行两次。

## #49.修复Group的错误算法

&emsp;&emsp;`Group`类获取鼠标指向的组件时没有调用组件的判断方法直接返回了组件，导致判断结果异常。

## \#50.添加合成表按钮

&emsp;&emsp;添加了隐形的合成表按钮，支持全自动调整坐标和尺寸。部分功能依赖`MComponent`执行，所以从该版本开始要求`MComponent`的子类重写`onAddToGUI`方法时必须调用父类对应的方法。

## \#49-修复Group的错误算法

&emsp;&emsp;`Group`类获取鼠标指向的组件时没有调用组件的判断方法直接返回了组件，导致判断结果异常。

## \#50.添加合成表按钮

&emsp;&emsp;添加了隐形的合成表按钮，支持全自动调整坐标和尺寸。部分功能依赖`MComponent`执行，所以从该版本开始要求`MComponent`的子类重写`onAddToGUI`方法时必须调用父类对应的方法。

## \#51-添加对已有所有合成表类型的显示支持

&emsp;&emsp;自动合成表显示目前已经支持对已有四种类型的合成表进行显示：

|      合成表类型      |                         特点介绍 |
| :------------------: | -------------------------------: |
|  `OrderlyShapeOnly`  |       原料列表有序，产物仅有一种 |
| `UnorderlyShapeOnly` |       原料列表无序，产物仅有一种 |
|    `OrderlyShape`    | 原料列表有序，产物有多种（无序） |
|   `UnorderlyShape`   | 原料列表无序，产物有多种（无序） |

<div class="text" style=" text-align:center;"><font size="2px" font color="#66ccff">注：原料列表有序即相当于有序合成表，无序则为无序合成表</font></div>

## \#52-修复打开空的合成表时游戏崩溃

&emsp;&emsp;修复打开空的合成表时抛出`IndexOutOfBoundException`及`IllegalArgumentException`导致的程序崩溃。

## #53.修复GUI网络通信时客户端服务端窗体对象可能不一致的漏洞

&emsp;&emsp;以往GUI进行网络通信时，通信内容中并没有存储发送信息的GUI的窗体信息，导致接收端无法判断窗体是否一致，该更新在通讯信息中加入了GUI窗体校验信息，辅助信息正确性校验。

## #54.修复点击合成表按钮响应多次的BUG

&emsp;&emsp;以往按钮注册事件的代码位置错误，导致同一个事件被多次注册，从而使按钮响应多次，该更新修改了注册机制，添加了专门的初始化接口，修正了该BUG。

## #55.添加配置功能

&emsp;&emsp;支持简单的配置功能，预备后续重新写一遍更高级的。

## #56.重写方块JSON生成器

&emsp;&emsp;重写了`BlockJsonBuilder`类，提供了更加高级的功能，支持多种方块的JSON生成，同时支持快捷的模板添加。

## #57.GUI显示调整

&emsp;&emsp;GUI中玩家背包上方添加“物品栏”文字。

## #58.修复自动读写崩溃问题

&emsp;&emsp;当需要存储的值为`null`时会导致存储失败并放弃剩余数据，该问题出现的原因是大部分情况下客户端的TE中并没有存储有效数据。解决方案：客户端不再触发自动读写。

## #59.实现本地GUI渲染

&emsp;&emsp;实现了本地子GUI渲染，允许玩家在已打开的GUI上再打开一个GUI。打开子GUI时会拦截原GUI的所有操作，当玩家尝试关闭GUI时只会关闭子GUI，而原GUI保持开启。

## #60.实现以玩家为凭借的双端通信

&emsp;&emsp;允许以玩家为`KEY`进行服务端客户端双端通信，为保持安全以`UUID`为凭借。

## #61.修复服务端SideOnly问题

&emsp;&emsp;修复因`SideOnly(CLIENT)`导致的服务端BUG。

## #62.修复两端数据不一致导致的BUG

&emsp;&emsp;修复因客户端与服务端`网络注册ID`和`GUI ID`不一致导致的问题。

## #63.修复GUI渲染问题

&emsp;&emsp;修复当传入数据为负值时导致的`CommonProgress`渲染异常。

## #64.字节层次的数据操作——dor

&emsp;&emsp;添加了自制的数据操作库`dor`，主要由`IDataReader`(读取器)和`IDataWriter`(写入器)组成。同时提供了两个默认实现：支持读写的`ByteDataOperator`以及只读的`ReadOnlyDataOperator`。

## #65.新的数据读写系统

&emsp;&emsp;编写全新的数据读写系统，除原本的`NBTTagCompound`支持外，新加了对`ByteBuf`及自制的`dor`的支持。

## #66.新的自动数据读写

&emsp;&emsp;依靠新的数据读写系统编写了全新的自动化数据读写库，运行主要依靠`IClassData`，实现了对数据的自动存储，同时支持数据类型转换。

## #67.完善合成表自动填充的功能

&emsp;&emsp;修复了合成表填充时存在的所有已知BUG，优化合成表显示。

## #68.网络通信换用dor系统

&emsp;&emsp;自动化网络通信全面抛弃`NBTTagCompound`，使用`dor`读写系统。

## #69.修复dor漏洞及优化功能

<ul>
    <li>修复读写数据时下标错误的更新</li>
    <li>修复读写占用多字节的数据时的错误移位操作</li>
    <li>修复读写varint时的错误移位操作</li>
    <li>优化不合理的写入顺序</li>
</ul>

